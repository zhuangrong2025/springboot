define("#/xyz-jsonRPC/0.1.39/xyz-jsonRPC",["#/lodash/lodash","#/stringformat/stringformat","#/xyz-alert/xyz-alert","#/xyz-util/xyz-util","#/xyz-cryptojs/xyz-cryptojs"],function(e,t,r){var n,s=e("#/lodash/lodash"),o=e("#/stringformat/stringformat"),i=e("#/xyz-alert/xyz-alert"),a=e("#/xyz-util/xyz-util"),u=e("#/xyz-cryptojs/xyz-cryptojs"),c={},f="xyz-jsonRPC",l="xyz-jsonRPC-config";window.xyzJsonRPCHost="",window.xyzJsonRPCDebug=!1,window.xyzJsonRPCMock=!1;var h="/";c.setHost=function(e){window.xyzJsonRPCHost=e},c.setDebug=function(e){window.xyzJsonRPCDebug=e},c.setMock=function(e){window.xyzJsonRPCMock=e},c.setConfigBase=function(e){h=e},c.request=function(e,t){var r=e.url;s.isString(e)?(r=e,e=t||{},e.url=r):r=e.url;var n=e.params||{params:{}};e.params=n,this._validateRequestUrl(r),this._validateRequestCallbacks(e.success,e.error),this._doRequest(r,n,e,e)},c.fetch=function(e,t,r){var i=e.indexOf(".");if(-1===i)throw"缺少.号";var a=e.substring(0,i),u=e.substring(i+1),c={};s.isFunction(t)?(r=t,t={}):(t||(t={}),t.params&&(c=t.params));var f=this;this._getConfigObj(a,t,function(e,i){if(e)throw o("获取配置文件出错: {0}",e.responseText);var a=i.ajax,l=s.find(a,function(e){return e.id===u});if(void 0===l)throw o("未找到id: {0}",u);var h=l.url;if(void 0===h)throw o("id为{0}的配置,缺少url属性",u);var d=n.extend(!0,l.params,c);f._doRequest(h,d,{url:h,params:d,cache:l.cache,cacheTime:l.cacheTime,success:function(e,t){r(null,e,t)},error:function(e){r(e)}},t)})},c.getPermissionAuth=function(e){var t=this._getMenuMessage(e),r=t.menuCode+","+t.funcCode+","+t.controlCode;return u.encryptByDESModeCBC(r)},c._getMenuMessage=function(e){e=e||{};var t="999999999",r="999999999",n=e.controlCode||"",s=window.ModulesGlobal&&window.ModulesGlobal.BaseCommonModule;if(s){var o=s.getActiveMenu();o&&(t=o.menu_code,r=o.func_code)}return{menuCode:t,funcCode:r,controlCode:n}},c.getAuthObj=function(e){var t=this._getMenuMessage(e),r=this.getPermissionAuth(e);return{menuCode:t.menuCode,auth:r}},c._validateRequestUrl=function(e){if("string"!=typeof e)throw"url格式不正确";return!0},c._validateRequestCallbacks=function(e,t){if(void 0!==e&&"function"!=typeof e)throw"success必须是个function";if(void 0!==t&&"function"!=typeof t)throw"error必须是个function";return!0},c._doRequest=function(e,t,r,n){var s=this,o=this._hasCache(e,r);o?this._requestSuccess(o,r,e):this._doAjax(e,t,n,function(e,t){s._requestSuccess(e,r,t,!0)},function(e,t){s._requestError(e,r,t)})},c._doAjax=function(e,t,r,o,i){var c=u.getTm(),f=this._getExheader(c),l=a.joinUrlParams(e,{tm:c}),h=r.serviceUri||"",d=this.getAuthObj(r);window.xyzJsonRPCDebug===!0&&(l=l.replace("USAccess","TestUSAccess")),l=window.xyzJsonRPCHost+l;var g={async:void 0===r.async?!0:r.async,type:"POST",dataType:"json",contentType:"application/json;charset=UTF-8",url:l,data:JSON.stringify(t),processData:!1,headers:{"Ex-h":f,"Ex-Service-Uri":h,PermissionAuthen:d.auth,MENU_CODE:d.menuCode},complete:r.complete,error:function(e){i&&i(e,l)},success:function(e){o&&o(e,l)}};if(window.xyzJsonRPCMock===!0){g.type="get";var m=a.getUrlParams(l),p=m.service,v=p.split("."),y=v.length,C=[];C.push(-1!==l.indexOf("/table/")?"/table":"/json"),s.each(v,function(e,t){C.push(t===y-1?e+".json":e)});var x=C.join("/"),_=location.href,w=_.indexOf("/release/");-1!==w&&(x=_.substring(0,w)+"/mock"+x),g.url=x,g.data=null}n.ajax(g)},c._getExheader=function(e){var t=u.encryptByCsrf(e);return t},c._requestError=function(e,t,r){var n=t.error;if(void 0!==n&&"function"==typeof n)if("string"==typeof e.responseText)try{var o=e.message,a=e.errorCode;if(s.isEmpty(o)&&(o=e.responseText),s.isEmpty(a)&&(a=-1),-1!==o.indexOf("<!DOCTYPE HTML"))try{window.IndexSupport.AppInfo.logout()}catch(u){top.window.parent.IndexSupport.AppInfo.logout()}n({error:{message:o,errorCode:a}},r)}catch(u){n(this._response(),r)}else n(this._response(),r);else if(e){var c=e.message||e.statusText;i.error(c)}},c._requestSuccess=function(e,t,r,n){var s=t.success,o=t.error;"function"!=typeof o&&(o=function(e){var t=e&&e.message||"";i.error(t)});var a=this._response(e);if(window.xyzJsonRPCMock)return void(a.result&&a.status?s(a.result,r):s(a,r));if(0!==a.status.code&&"function"==typeof o)return void o({code:-1,message:a.status.message},r);if(a.result&&0!==a.result.retCode){var u=a.result;return void(u.directURL?999e3===u.retCode?top.window.location.href=u.directURL:location.href=u.directURL:o(u,r))}"function"==typeof s&&(s(a.result,r),t.cache===!0&&n===!0&&this._setCache(t.url,t.params,a))},c._response=function(e){if(void 0===e)return{message:"Internal server error",error:"Internal server error",version:"2.1"};try{if("string"==typeof e&&(e=JSON.parse(e)),!e.result)return e;if(n.isArray(e)&&e.result.length>0&&"2.1"!==e[0].result.jsonrpc||!n.isArray(e.result)&&"2.1"!==e.result.jsonrpc)throw"版本错误";return e}catch(t){return{error:"Internal server error: "+t,version:"2.1"}}},c._hasCache=function(e,t){var r=t.cache;if(r!==!1){var n=t.params,o=t.cacheTime||5,i=60*o*1e3,a=this._getCacheObj(f),u=s.find(a,function(t){return t.url===e&&s.isEqual(t.params,n)}),c=this._getNow();if(u){var l=u.time;return c-l>i?(this.removeDataCache(e,n),!1):u.data}return!1}return!1},c._getCacheObj=function(e){var t=localStorage.getItem(e),r=e===f,n=r?[]:{};if(!t)return this._setItem(e,n),n;try{var s=JSON.parse(t);return s}catch(o){return this._setItem(e,n),n}},c._setCache=function(e,t,r){var n=this.removeDataCache(e,t);n.push({url:e,params:t,data:r,time:this._getNow()}),this._setItem(f,n)},c._getNow=function(){return(new Date).getTime()},c.removeDataCache=function(e,t){var r=this._getCacheObj(f);return s.remove(r,function(r){return r.url===e&&s.isEqual(r.params,t)}),this._setItem(f,r),r},c._getConfigObj=function(e,t,r){var n=this._getCacheObj(l),s=n[e],i=this._getNow(),a=this,u=function(){"/"===h?h="":"/"===h.charAt(h.length-1)&&(h=h.substring(0,h.length-1));var s=o("{0}/{1}{2}",h,e,t.ext||"");a._doAjax(s,{},t,function(t){t.cache===!0&&(t.time=i,t.cacheTime=t.cacheTime||5,n[e]=t,a._setItem(l,n)),r(null,t)},function(e){r(e)})};if(s){var c=s.time,f=s.cacheTime||5,d=60*f*1e3;i-c>d?u():r(null,s)}else u()},c._setItem=function(e,t){var r=JSON.stringify(t);try{localStorage.setItem(e,r)}catch(n){localStorage.clear(),localStorage.setItem(e,r)}},r.exports=function(e){n=e,n.jsonRPC=c,n.getExheader=c._getExheader}},{});